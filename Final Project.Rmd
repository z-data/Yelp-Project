---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
# Load the package required
library("jsonlite")
library(tibble)
library(yelpr)
library(dplyr)

# Get my API key
key = readLines("Yelp API.txt", warn = F)


#I tried a few times and it seems borough by borough is best 
#Manhattan restaurant calls 
resturants = data.frame()
for (i in 0:99) {
  
  temp = business_search(api_key = key,
                  location = 'Manhattan',
                  term = "resturants",
                  limit = 50,
                  offset = 50*i)
  resturants = bind_rows(resturants, as.data.frame(temp))
}
#Brooklyn restaurant calls 
for (i in 0:99) {
  
  temp = business_search(api_key = key,
                  location = 'Brooklyn',
                  term = "resturants",
                  limit = 50,
                  offset = 50*i)
  resturants = bind_rows(resturants, as.data.frame(temp))
}
#Queens restaurant calls 
for (i in 0:99) {
  
  temp = business_search(api_key = key,
                  location = 'Queens',
                  term = "resturants",
                  limit = 50,
                  offset = 50*i)
  resturants = bind_rows(resturants, as.data.frame(temp))
}
#Bronx restaurant calls
for (i in 0:99) {
  
  temp = business_search(api_key = key,
                  location = 'Bronx',
                  term = "resturants",
                  limit = 50,
                  offset = 50*i)
  resturants = bind_rows(resturants, as.data.frame(temp))
}

dim(resturants)
unique(resturants$businesses.location$city)
head(resturants)
```


```{r}
table(resturants$businesses.is_closed, useNA = "ifany")
```
LG: This is a problem - can we accurately conclude that NA fields are restaurants that have closed? 

```{r}
hist(resturants$businesses.rating,xlab = "ratings out of 5", main = "Histogram of business ratings")
```
```{r}
table(resturants$businesses.price, useNA = "ifany")
```

```{r}
barplot(height = table(resturants$businesses.price,  useNA = "ifany"), 
        names.arg = names(table(resturants$businesses.price, useNA = "ifany")))
```
```{r}
hist(resturants$businesses.review_count, xlab = "Number of reviews", main = "Histogram of review Dist")
```

Yelp Dataset for Academic purposed as of March 2020


```{r}
yelp_biz = jsonlite::stream_in(file( "/Users/lukasgeiger/Desktop/Columbia/SeniorYear/Spring2021/AppliedDataMining/FinalProject/yelp_dataset/yelp_academic_dataset_business.json"))
yelp_flat = jsonlite::flatten(yelp_biz)
yelp_tbl = as_tibble(yelp_flat)
# However, most of this data is from BC, CO, FL, GA, MA, OH, OR, and TX (Not NY)
table(yelp_tbl$state)
# It is a very large dataset
dim(yelp_tbl)
names(yelp_tbl)
#Include more than restaurants 
yelp_tbl %>% mutate(categories = as.character(categories)) %>% select(categories)
```

```{r}
COVID_data = jsonlite::stream_in(file( "/Users/lukasgeiger/Desktop/Columbia/SeniorYear/Spring2021/AppliedDataMining/FinalProject/covid_19_dataset_2020_06_10/yelp_academic_dataset_covid_features.json"))
covid_flat = jsonlite::flatten(COVID_data)
covid_yelp_tbl = as_tibble(covid_flat)
```


```{r}
combined_tbl = yelp_tbl %>% right_join(covid_yelp_tbl)
# There are only two businesses with the same business id in the two tibbles.
```
```{r}
businesses = data.frame()
index = 1
for (biz in covid_yelp_tbl$business_id){
  temp = business_lookup_id(api_key = key, 
                            business_id = biz)
  temp_biz = bind_cols(as.data.frame(bind_cols(temp)[1,]), covid_yelp_tbl[index,])
  businesses = bind_rows(businesses, temp_biz)
  index = index + 1
}
```
































